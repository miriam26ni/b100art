<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crear cuenta • B100Art</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  <style>
    :root { --bg:#0f172a; --card:#1e293b; --accent:#d4af37; --gold:#facc15; }
    body { font-family: 'Inter', system-ui, sans-serif; background: linear-gradient(180deg, #071029, #071b2a);
      min-height: 100vh; display: flex; align-items: center; justify-content: center;
      margin: 0; padding: 20px; color: #e6eef8; }
    .card { background: rgba(255,255,255,0.04); border-radius: 16px; padding: 36px; width: 100%; max-width: 440px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.08); }
    h1 { text-align:center; color:var(--gold); font-size:1.9rem; margin-bottom:8px; }
    label { display:block; margin-top:18px; font-size:0.9rem; opacity:0.9; font-weight:500; }
    input, .ts-wrapper { width:100%; margin-top:6px; border-radius:10px; background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1); padding:12px 14px; color:white; }
    input[type="password"] { font-family: system-ui; letter-spacing: 2px; }
    .phone-group { display:flex; gap:10px; margin-top:6px; }
    #countryCode { width:140px; }
    button { width:100%; padding:14px; margin-top:28px; border:none; border-radius:12px;
      background:linear-gradient(90deg,var(--gold),#facc15); color:#000; font-weight:700;
      font-size:1.1rem; cursor:pointer; transition:all .3s; }
    button:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 10px 30px rgba(212,175,55,.4); }
    button:disabled { opacity:0.7; cursor:not-allowed; }
    .msg { margin-top:16px; text-align:center; font-size:0.9rem; }
    .success { color:#4ade80; }
    .error { color:#f87171; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Crear cuenta</h1>
    <p style="text-align:center;opacity:0.9;margin-bottom:24px;">Completa todos los campos</p>
    <form id="auth-form">
      <label>Nombre completo</label>
      <input type="text" id="nombre" required placeholder="Juan Pérez">
      <label>Fecha de nacimiento</label>
      <input type="date" id="fecha_nac" required max="2007-12-31">
      <label>Nacionalidad</label>
      <input type="text" id="nacionalidad" required placeholder="Mexicana, Española...">
      <label>Teléfono</label>
      <div class="phone-group">
        <select id="countryCode" required></select>
        <input type="tel" id="phone" required placeholder="442 123 4567">
      </div>
      <label>Dirección completa</label>
      <input type="text" id="direccion" required placeholder="Calle, número, colonia...">
      <label>Ciudad</label>
      <input type="text" id="ciudad" required placeholder="Ciudad de México">
      <label>País de residencia</label>
      <input type="text" id="pais" required placeholder="México">
      <label>Email</label>
      <input type="email" id="email" required placeholder="tucorreo@gmail.com">
      <label>Contraseña</label>
      <input type="password" id="password" required minlength="6" placeholder="Mínimo 6 caracteres">
      <button type="submit" id="btn">Crear cuenta y continuar</button>
      <div class="msg" id="mensaje"></div>
    </form>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    const supabase = createClient(
      'https://jkiwfvolipgttkyxcndc.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpraXdmdm9saXBndHRreXhjbmRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNzIyODksImV4cCI6MjA3OTg0ODI4OX0.lBGeIM4w6Gzy3dopkZMMAGr3_9uL1JHRRxq5URUhZEU'
    )

    const paises = [
      {value:"+1", text:"+1 Estados Unidos"},
      {value:"+1", text:"+1 Canadá"},
      {value:"+52", text:"+52 México"},
      {value:"+34", text:"+34 España"},
      {value:"+54", text:"+54 Argentina"},
      {value:"+51", text:"+51 Perú"},
      {value:"+57", text:"+57 Colombia"},
      {value:"+56", text:"+56 Chile"},
      {value:"+58", text:"+58 Venezuela"},
      {value:"+591", text:"+591 Bolivia"},
      {value:"+595", text:"+595 Paraguay"},
      {value:"+598", text:"+598 Uruguay"},
      {value:"+593", text:"+593 Ecuador"},
      {value:"+507", text:"+507 Panamá"},
      {value:"+506", text:"+506 Costa Rica"},
      {value:"+503", text:"+503 El Salvador"},
      {value:"+504", text:"+504 Honduras"},
      {value:"+505", text:"+505 Nicaragua"},
      {value:"+502", text:"+502 Guatemala"},
      {value:"+1-268", text:"+1-268 Antigua y Barbuda"},
      {value:"+1-242", text:"+1-242 Bahamas"},
      {value:"+1-246", text:"+1-246 Barbados"},
      {value:"+1-441", text:"+1-441 Bermudas"},
      {value:"+1-767", text:"+1-767 Dominica"},
      {value:"+1-809", text:"+1-809 Rep. Dominicana"},
      {value:"+1-829", text:"+1-829 Rep. Dominicana"},
      {value:"+1-849", text:"+1-849 Rep. Dominicana"},
      {value:"+1-473", text:"+1-473 Granada"},
      {value:"+1-876", text:"+1-876 Jamaica"},
      {value:"+1-869", text:"+1-869 San Cristóbal y Nieves"},
      {value:"+1-784", text:"+1-784 San Vicente"},
      {value:"+1-868", text:"+1-868 Trinidad y Tobago"},
      {value:"+44", text:"+44 Reino Unido"},
      {value:"+33", text:"+33 Francia"},
      {value:"+49", text:"+49 Alemania"},
      {value:"+39", text:"+39 Italia"},
      {value:"+351", text:"+351 Portugal"},
      {value:"+31", text:"+31 Países Bajos"},
      {value:"+32", text:"+32 Bélgica"},
      {value:"+41", text:"+41 Suiza"},
      {value:"+43", text:"+43 Austria"},
      {value:"+45", text:"+45 Dinamarca"},
      {value:"+46", text:"+46 Suecia"},
      {value:"+47", text:"+47 Noruega"},
      {value:"+358", text:"+358 Finlandia"},
      {value:"+7", text:"+7 Rusia"},
      {value:"+86", text:"+86 China"},
      {value:"+81", text:"+81 Japón"},
      {value:"+82", text:"+82 Corea del Sur"},
      {value:"+91", text:"+91 India"},
      {value:"+55", text:"+55 Brasil"},
      {value:"+93", text:"+93 Afganistán"},
      {value:"+355", text:"+355 Albania"},
      {value:"+213", text:"+213 Argelia"},
      {value:"+376", text:"+376 Andorra"},
      {value:"+244", text:"+244 Angola"},
      {value:"+374", text:"+374 Armenia"},
      {value:"+297", text:"+297 Aruba"},
      {value:"+61", text:"+61 Australia"},
      {value:"+994", text:"+994 Azerbaiyán"},
      {value:"+973", text:"+973 Baréin"},
      {value:"+880", text:"+880 Bangladés"},
      {value:"+375", text:"+375 Bielorrusia"},
      {value:"+501", text:"+501 Belice"},
      {value:"+229", text:"+229 Benín"},
      {value:"+975", text:"+975 Bután"},
      {value:"+387", text:"+387 Bosnia y Herzegovina"},
      {value:"+267", text:"+267 Botsuana"},
      {value:"+673", text:"+673 Brunéi"},
      {value:"+359", text:"+359 Bulgaria"},
      {value:"+226", text:"+226 Burkina Faso"},
      {value:"+257", text:"+257 Burundi"},
      {value:"+238", text:"+238 Cabo Verde"},
      {value:"+855", text:"+855 Camboya"},
      {value:"+237", text:"+237 Camerún"},
      {value:"+236", text:"+236 Rep. Centroafricana"},
      {value:"+235", text:"+235 Chad"},
      {value:"+269", text:"+269 Comoras"},
      {value:"+242", text:"+242 Congo (Brazzaville)"},
      {value:"+243", text:"+243 Congo (Kinshasa)"},
      {value:"+385", text:"+385 Croacia"},
      {value:"+53", text:"+53 Cuba"},
      {value:"+357", text:"+357 Chipre"},
      {value:"+420", text:"+420 Rep. Checa"},
      {value:"+253", text:"+253 Yibuti"},
      {value:"+20", text:"+20 Egipto"},
      {value:"+240", text:"+240 Guinea Ecuatorial"},
      {value:"+291", text:"+291 Eritrea"},
      {value:"+372", text:"+372 Estonia"},
      {value:"+268", text:"+268 Esuatini"},
      {value:"+251", text:"+251 Etiopía"},
      {value:"+679", text:"+679 Fiyi"},
      {value:"+241", text:"+241 Gabón"},
      {value:"+220", text:"+220 Gambia"},
      {value:"+995", text:"+995 Georgia"},
      {value:"+233", text:"+233 Ghana"},
      {value:"+30", text:"+30 Grecia"},
      {value:"+224", text:"+224 Guinea"},
      {value:"+245", text:"+245 Guinea-Bisáu"},
      {value:"+592", text:"+592 Guyana"},
      {value:"+509", text:"+509 Haití"},
      {value:"+36", text:"+36 Hungría"},
      {value:"+354", text:"+354 Islandia"},
      {value:"+62", text:"+62 Indonesia"},
      {value:"+98", text:"+98 Irán"},
      {value:"+964", text:"+964 Irak"},
      {value:"+353", text:"+353 Irlanda"},
      {value:"+972", text:"+972 Israel"},
      {value:"+962", text:"+962 Jordania"},
      {value:"+7", text:"+7 Kazajistán"},
      {value:"+254", text:"+254 Kenia"},
      {value:"+686", text:"+686 Kiribati"},
      {value:"+383", text:"+383 Kosovo"},
      {value:"+965", text:"+965 Kuwait"},
      {value:"+996", text:"+996 Kirguistán"},
      {value:"+856", text:"+856 Laos"},
      {value:"+371", text:"+371 Letonia"},
      {value:"+961", text:"+961 Líbano"},
      {value:"+266", text:"+266 Lesoto"},
      {value:"+231", text:"+231 Liberia"},
      {value:"+218", text:"+218 Libia"},
      {value:"+423", text:"+423 Liechtenstein"},
      {value:"+370", text:"+370 Lituania"},
      {value:"+352", text:"+352 Luxemburgo"},
      {value:"+389", text:"+389 Macedonia del Norte"},
      {value:"+261", text:"+261 Madagascar"},
      {value:"+265", text:"+265 Malaui"},
      {value:"+60", text:"+60 Malasia"},
      {value:"+960", text:"+960 Maldivas"},
      {value:"+223", text:"+223 Malí"},
      {value:"+356", text:"+356 Malta"},
      {value:"+692", text:"+692 Islas Marshall"},
      {value:"+222", text:"+222 Mauritania"},
      {value:"+230", text:"+230 Mauricio"},
      {value:"+691", text:"+691 Micronesia"},
      {value:"+373", text:"+373 Moldavia"},
      {value:"+377", text:"+377 Mónaco"},
      {value:"+976", text:"+976 Mongolia"},
      {value:"+382", text:"+382 Montenegro"},
      {value:"+212", text:"+212 Marruecos"},
      {value:"+258", text:"+258 Mozambique"},
      {value:"+95", text:"+95 Myanmar"},
      {value:"+264", text:"+264 Namibia"},
      {value:"+674", text:"+674 Nauru"},
      {value:"+977", text:"+977 Nepal"},
      {value:"+64", text:"+64 Nueva Zelanda"},
      {value:"+227", text:"+227 Níger"},
      {value:"+234", text:"+234 Nigeria"},
      {value:"+968", text:"+968 Omán"},
      {value:"+92", text:"+92 Pakistán"},
      {value:"+680", text:"+680 Palaos"},
      {value:"+675", text:"+675 Papúa Nueva Guinea"},
      {value:"+63", text:"+63 Filipinas"},
      {value:"+48", text:"+48 Polonia"},
      {value:"+974", text:"+974 Catar"},
      {value:"+40", text:"+40 Rumanía"},
      {value:"+250", text:"+250 Ruanda"},
      {value:"+685", text:"+685 Samoa"},
      {value:"+378", text:"+378 San Marino"},
      {value:"+239", text:"+239 Santo Tomé y Príncipe"},
      {value:"+966", text:"+966 Arabia Saudita"},
      {value:"+221", text:"+221 Senegal"},
      {value:"+381", text:"+381 Serbia"},
      {value:"+248", text:"+248 Seychelles"},
      {value:"+232", text:"+232 Sierra Leona"},
      {value:"+65", text:"+65 Singapur"},
      {value:"+421", text:"+421 Eslovaquia"},
      {value:"+386", text:"+386 Eslovenia"},
      {value:"+677", text:"+677 Islas Salomón"},
      {value:"+252", text:"+252 Somalia"},
      {value:"+27", text:"+27 Sudáfrica"},
      {value:"+211", text:"+211 Sudán del Sur"},
      {value:"+94", text:"+94 Sri Lanka"},
      {value:"+249", text:"+249 Sudán"},
      {value:"+597", text:"+597 Surinam"},
      {value:"+963", text:"+963 Siria"},
      {value:"+886", text:"+886 Taiwán"},
      {value:"+992", text:"+992 Tayikistán"},
      {value:"+255", text:"+255 Tanzania"},
      {value:"+66", text:"+66 Tailandia"},
      {value:"+670", text:"+670 Timor Oriental"},
      {value:"+228", text:"+228 Togo"},
      {value:"+676", text:"+676 Tonga"},
      {value:"+216", text:"+216 Túnez"},
      {value:"+90", text:"+90 Turquía"},
      {value:"+993", text:"+993 Turkmenistán"},
      {value:"+688", text:"+688 Tuvalu"},
      {value:"+256", text:"+256 Uganda"},
      {value:"+380", text:"+380 Ucrania"},
      {value:"+971", text:"+971 Emiratos Árabes Unidos"},
      {value:"+678", text:"+678 Vanuatu"},
      {value:"+379", text:"+379 Ciudad del Vaticano"},
      {value:"+84", text:"+84 Vietnam"},
      {value:"+967", text:"+967 Yemen"},
      {value:"+260", text:"+260 Zambia"},
      {value:"+263", text:"+263 Zimbabue"}
    ];

    new TomSelect("#countryCode", {
      maxOptions: null,
      placeholder: "Código",
      options: paises,
      searchField: ["text"],
      render: {
        option: function(data, escape) { return `<div>${escape(data.text)}</div>`; },
        item: function(data, escape) { return `<div>${escape(data.text)}</div>`; }
      }
    });

    document.getElementById('auth-form').addEventListener('submit', async e => {
      e.preventDefault();
      const btn = document.getElementById('btn');
      const msg = document.getElementById('mensaje');
      btn.disabled = true;
      btn.textContent = 'Creando cuenta...';
      msg.textContent = '';

      const datos = {
        nombre: e.target.nombre.value.trim(),
        fecha_nac: e.target.fecha_nac.value,
        nacionalidad: e.target.nacionalidad.value.trim(),
        telefono: document.querySelector('#countryCode-ts-control')?.innerText.trim() + ' ' + e.target.phone.value.trim(),
        direccion: e.target.direccion.value.trim(),
        ciudad: e.target.ciudad.value.trim(),
        pais: e.target.pais.value.trim(),
        email: e.target.email.value.toLowerCase().trim(),
      };

      const password = e.target.password.value;

      const { data, error } = await supabase.auth.signUp({
        email: datos.email,
        password: password,
      });

      if (error) {
        msg.innerHTML = `<span class="error">${error.message}</span>`;
        btn.disabled = false;
        btn.textContent = 'Crear cuenta y continuar';
        return;
      }

      // ← SOLUCIÓN: upsert + onConflict permite insertar el id manualmente
      const { error: dbError } = await supabase
        .from('usuarios')
        .upsert({
          id: data.user.id,
          nombre: datos.nombre,
          fecha_nac: datos.fecha_nac,
          nacionalidad: datos.nacionalidad,
          telefono: datos.telefono,
          direccion: datos.direccion,
          ciudad: datos.ciudad,
          pais: datos.pais,
          email: datos.email,
          created_at: new Date().toISOString()
        }, { onConflict: 'id' });

      if (dbError) {
        msg.innerHTML = `<span class="error">Error al guardar datos: ${dbError.message}</span>`;
      } else {
        msg.innerHTML = `<span class="success">¡Cuenta creada con éxito!</span>`;
        setTimeout(() => window.location.href = 'https://b100art.digital/panel.html', 1500);
      }

      btn.disabled = false;
      btn.textContent = 'Crear cuenta y continuar';
    });
  </script>
</body>
</html>